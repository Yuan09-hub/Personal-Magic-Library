<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¹¦æˆ¿ - ä¹¦ç±ç®¡ç†</title>
    <link rel="stylesheet" href="style.css">
    <script>
        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
        function toggleMenu() {
            const navLinks = document.querySelector('.nav-links');
            navLinks.classList.toggle('active');
        }
        
        // è·å–æ‰€æœ‰ä¹¦ç±
        function getAllBooks() {
            try {
                let books = [];
                const booksStr = localStorage.getItem('books');
                if (booksStr) {
                    books = JSON.parse(booksStr);
                }
                
                // ç¡®ä¿ä¹¦ç±åˆ—è¡¨æ˜¯æ•°ç»„
                if (!Array.isArray(books)) {
                    books = [];
                }
                
                return books;
            } catch (error) {
                console.error('getAllBooks é”™è¯¯:', error);
                return [];
            }
        }
        
        // æ¸²æŸ“ä¹¦ç±åˆ—è¡¨
        function renderBooks() {
            const books = getAllBooks();
            const bookList = document.getElementById('bookList');
            
            if (books.length === 0) {
                bookList.innerHTML = `
                    <div class="empty-shelf" style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #d4a76a;">
                        <p>ğŸ“š ä½ çš„ä¹¦æ¶è¿˜æ²¡æœ‰ä¹¦ç±</p>
                        <p>å»é¦–é¡µæ·»åŠ ä½ çš„ç¬¬ä¸€æœ¬ä¹¦å§ï¼</p>
                        <a href="index.html" class="btn" style="margin-top: 1rem;">æ·»åŠ ä¹¦ç±</a>
                    </div>
                `;
                return;
            }
            
            // æŒ‰åˆ†ç±»åˆ†ç»„
            const booksByCategory = {};
            books.forEach(book => {
                if (!booksByCategory[book.category]) {
                    booksByCategory[book.category] = [];
                }
                booksByCategory[book.category].push(book);
            });
            
            let html = '';
            for (const category in booksByCategory) {
                html += `
                    <div class="category-section">
                        <h3 class="category-title">${getCategoryName(category)}</h3>
                        <div class="category-books">
                `;
                
                booksByCategory[category].forEach(book => {
                    html += `
                        <div class="book-item-admin" data-book-id="${book.id}">
                            <div class="book-cover-small" style="${book.coverUrl ? `background-image: url('${book.coverUrl}'); background-size: cover; background-position: center;` : `background: linear-gradient(135deg, #8b4513 0%, #d4a76a 100%);`}">
                                ${!book.coverUrl ? book.title.charAt(0) : ''}
                            </div>
                            <div class="book-info-admin">
                                <h4>${book.title}</h4>
                                <p class="book-author-admin">${book.author} (${book.authorCountry})</p>
                                ${book.originalTitle ? `<p class="book-meta-admin">åŸä¹¦å: ${book.originalTitle}</p>` : ''}
                                ${book.translator ? `<p class="book-meta-admin">è¯‘è€…: ${book.translator}</p>` : ''}
                                <p class="book-category-admin">åˆ†ç±»: ${getCategoryName(book.category)}</p>
                                <p class="book-added-admin">æ·»åŠ æ—¶é—´: ${new Date(book.addedAt).toLocaleString('zh-CN')}</p>
                            </div>
                            <div class="book-actions-admin">
                                <button class="action-btn edit-btn" onclick="editBook(${book.id})"><span>âœï¸</span> ç¼–è¾‘</button>
                                <button class="action-btn delete-btn" onclick="deleteBook(${book.id})"><span>ğŸ—‘ï¸</span> åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            bookList.innerHTML = html;
        }
        
        // è·å–åˆ†ç±»åç§°
        function getCategoryName(categoryValue) {
            const categoryNames = {
                'literature': 'æ–‡å­¦',
                'history': 'å†å²',
                'philosophy': 'å“²å­¦',
                'science': 'ç§‘å­¦',
                'art': 'è‰ºæœ¯',
                'other': 'å…¶ä»–'
            };
            return categoryNames[categoryValue] || categoryValue;
        }
        
        // è·å–ä¹¦ç±å¯¹è±¡
        function getBookById(bookId) {
            try {
                // å®‰å…¨åœ°è¯»å–å’Œè§£ælocalStorage
                let books = [];
                const booksStr = localStorage.getItem('books');
                if (booksStr) {
                    books = JSON.parse(booksStr);
                }
                
                // ç¡®ä¿ä¹¦ç±åˆ—è¡¨æ˜¯æ•°ç»„
                if (!Array.isArray(books)) {
                    books = [];
                }
                
                console.log('getBookById - ä¹¦ç±åˆ—è¡¨:', books);
                console.log('getBookById - æŸ¥æ‰¾çš„ID:', bookId, 'ç±»å‹:', typeof bookId);
                
                // å°è¯•å¤šç§åŒ¹é…æ–¹å¼ï¼Œç¡®ä¿èƒ½æ‰¾åˆ°ä¹¦ç±
                let book = null;
                
                // 1. ç›´æ¥åŒ¹é…ï¼ˆä¿æŒåŸæœ‰ç±»å‹ï¼‰
                book = books.find(book => book.id === bookId);
                console.log('getBookById - ç›´æ¥åŒ¹é…ç»“æœ:', book);
                
                // 2. å¦‚æœç›´æ¥åŒ¹é…å¤±è´¥ï¼Œå°è¯•è½¬æ¢ä¸ºæ•°å­—ç±»å‹åŒ¹é…
                if (!book) {
                    const idAsNumber = typeof bookId === 'string' ? parseInt(bookId) : bookId;
                    book = books.find(book => {
                        const bookIdNum = typeof book.id === 'string' ? parseInt(book.id) : book.id;
                        return bookIdNum === idAsNumber;
                    });
                    console.log('getBookById - æ•°å­—ç±»å‹åŒ¹é…ç»“æœ:', book);
                }
                
                // 3. å¦‚æœä»å¤±è´¥ï¼Œå°è¯•è½¬æ¢ä¸ºå­—ç¬¦ä¸²ç±»å‹åŒ¹é…
                if (!book) {
                    const idAsString = bookId.toString();
                    book = books.find(book => {
                        const bookIdStr = book.id.toString();
                        return bookIdStr === idAsString;
                    });
                    console.log('getBookById - å­—ç¬¦ä¸²ç±»å‹åŒ¹é…ç»“æœ:', book);
                }
                
                return book;
            } catch (error) {
                console.error('getBookById é”™è¯¯:', error);
                return null;
            }
        }
        
        // åˆ é™¤ä¹¦ç±
        function deleteBook(bookId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬ä¹¦å—ï¼Ÿ')) {
                // ä»æœ¬åœ°å­˜å‚¨ä¸­åˆ é™¤
                let books = getAllBooks();
                books = books.filter(book => book.id !== bookId);
                localStorage.setItem('books', JSON.stringify(books));
                
                // æ›´æ–°æœ€è¿‘é˜…è¯»
                let recentBooks = JSON.parse(localStorage.getItem('recentBooks')) || [];
                recentBooks = recentBooks.filter(book => book.id !== bookId);
                localStorage.setItem('recentBooks', JSON.stringify(recentBooks));
                
                // é‡æ–°æ¸²æŸ“ä¹¦ç±åˆ—è¡¨
                renderBooks();
                
                alert('ä¹¦ç±åˆ é™¤æˆåŠŸï¼');
            }
        }
        
        // æ‰“å¼€ç¼–è¾‘è¡¨å•
        function editBook(bookId) {
            const book = getBookById(bookId);
            if (!book) {
                alert('æœªæ‰¾åˆ°è¯¥ä¹¦ç±ï¼');
                return;
            }
            
            // åˆ›å»ºç¼–è¾‘è¡¨å•å¼¹çª—
            let popup = document.getElementById('editBookPopup');
            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'editBookPopup';
                popup.className = 'book-details-popup';
                document.body.appendChild(popup);
            }
            
            // æ„å»ºç¼–è¾‘è¡¨å•HTML
            popup.innerHTML = `
                <div class="book-details-content">
                    <div class="popup-header">
                        <h3>ä¿®æ”¹ä¹¦ç±ä¿¡æ¯</h3>
                        <button class="close-btn" onclick="closeEditForm()">&times;</button>
                    </div>
                    <div class="edit-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-title">ä¹¦åï¼š</label>
                                <input type="text" id="edit-title" value="${book.title}" class="edit-input">
                            </div>
                            <div class="form-group">
                                <label for="edit-author">ä½œè€…ï¼š</label>
                                <input type="text" id="edit-author" value="${book.author}" class="edit-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-author-country">ä½œè€…å›½ç±ï¼š</label>
                                <input type="text" id="edit-author-country" value="${book.authorCountry}" class="edit-input">
                            </div>
                            <div class="form-group">
                                <label for="edit-original-title">åŸä¹¦åï¼š</label>
                                <input type="text" id="edit-original-title" value="${book.originalTitle}" class="edit-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-translator">è¯‘è€…ï¼š</label>
                                <input type="text" id="edit-translator" value="${book.translator}" class="edit-input">
                            </div>
                            <div class="form-group">
                                <label for="edit-category">åˆ†ç±»ï¼š</label>
                                <select id="edit-category" class="edit-input">
                                    <option value="literature" ${book.category === 'literature' ? 'selected' : ''}>æ–‡å­¦</option>
                                    <option value="history" ${book.category === 'history' ? 'selected' : ''}>å†å²</option>
                                    <option value="philosophy" ${book.category === 'philosophy' ? 'selected' : ''}>å“²å­¦</option>
                                    <option value="science" ${book.category === 'science' ? 'selected' : ''}>ç§‘å­¦</option>
                                    <option value="art" ${book.category === 'art' ? 'selected' : ''}>è‰ºæœ¯</option>
                                    <option value="other" ${book.category === 'other' ? 'selected' : ''}>å…¶ä»–</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="edit-cover">ä¹¦ç±å°é¢å›¾ï¼ˆå¯é€‰ï¼Œæ”¯æŒ.jpg/.pngï¼‰ï¼š</label>
                                <div class="file-input-container">
                                    <input type="file" id="edit-cover" accept=".jpg,.png" class="file-input">
                                    <label for="edit-cover" class="file-input-label">é€‰æ‹©å°é¢å›¾</label>
                                </div>
                                <input type="hidden" id="edit-current-cover" value="${book.coverUrl || ''}">
                                ${book.coverUrl ? `<div class="current-cover" style="margin-top: 1rem;"><img src="${book.coverUrl}" alt="å½“å‰å°é¢" style="max-width: 100px; max-height: 150px; border: 2px solid #d4a76a; border-radius: 5px;"></div>` : ''}
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="cancel-btn" onclick="closeEditForm()">å–æ¶ˆ</button>
                            <button type="button" class="save-btn" onclick="saveBookChanges(${book.id})">ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </div>
                </div>
            `;
            
            popup.classList.add('active');
        }
        
        // å…³é—­ç¼–è¾‘è¡¨å•
        function closeEditForm() {
            const popup = document.getElementById('editBookPopup');
            if (popup) {
                popup.classList.remove('active');
            }
        }
        
        // ä¿å­˜ä¹¦ç±ä¿®æ”¹
        function saveBookChanges(bookId) {
            // è·å–ä¿®æ”¹åçš„ä¿¡æ¯
            const title = document.getElementById('edit-title').value.trim();
            const author = document.getElementById('edit-author').value.trim();
            const authorCountry = document.getElementById('edit-author-country').value.trim();
            const originalTitle = document.getElementById('edit-original-title').value.trim();
            const translator = document.getElementById('edit-translator').value.trim();
            const category = document.getElementById('edit-category').value;
            const coverFile = document.getElementById('edit-cover').files[0];
            const currentCoverUrl = document.getElementById('edit-current-cover').value;
            
            // éªŒè¯å¿…å¡«é¡¹
            if (!title || !author || !authorCountry || !category) {
                alert('è¯·å¡«å†™å¿…å¡«å­—æ®µï¼šä¹¦åã€ä½œè€…ã€ä½œè€…å›½ç±å’Œåˆ†ç±»ï¼');
                return;
            }
            
            // å¤„ç†å°é¢å›¾
            if (coverFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const coverUrl = e.target.result;
                    updateBook(bookId, title, author, authorCountry, originalTitle, translator, category, coverUrl);
                };
                reader.readAsDataURL(coverFile);
            } else {
                // ä½¿ç”¨ç°æœ‰å°é¢å›¾
                updateBook(bookId, title, author, authorCountry, originalTitle, translator, category, currentCoverUrl);
            }
        }
        
        // æ›´æ–°ä¹¦ç±ä¿¡æ¯
        function updateBook(bookId, title, author, authorCountry, originalTitle, translator, category, coverUrl) {
            // ä»æœ¬åœ°å­˜å‚¨ä¸­è·å–ä¹¦ç±åˆ—è¡¨
            let books = getAllBooks();
            const bookIndex = books.findIndex(book => book.id === bookId);
            
            if (bookIndex !== -1) {
                // æ›´æ–°æœ¬åœ°å­˜å‚¨
                const updatedBook = {
                    ...books[bookIndex],
                    title,
                    author,
                    authorCountry,
                    originalTitle,
                    translator,
                    category,
                    coverUrl
                };
                books[bookIndex] = updatedBook;
                localStorage.setItem('books', JSON.stringify(books));
                
                // æ›´æ–°æœ€è¿‘é˜…è¯»
                let recentBooks = JSON.parse(localStorage.getItem('recentBooks')) || [];
                const recentIndex = recentBooks.findIndex(book => book.id === bookId);
                if (recentIndex !== -1) {
                    recentBooks[recentIndex] = updatedBook;
                    localStorage.setItem('recentBooks', JSON.stringify(recentBooks));
                }
                
                // å…³é—­ç¼–è¾‘è¡¨å•
                closeEditForm();
                
                // é‡æ–°æ¸²æŸ“ä¹¦ç±åˆ—è¡¨
                renderBooks();
                
                alert('ä¹¦ç±ä¿¡æ¯ä¿®æ”¹æˆåŠŸï¼');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            renderBooks();
        };
    </script>
    <style>
        /* ä¹¦ç±ç®¡ç†é¡µé¢ä¸“ç”¨æ ·å¼ */
        .category-section {
            margin-bottom: 2rem;
            background: rgba(26, 18, 10, 0.9);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
            border: 2px solid #d4a76a;
        }
        
        .category-title {
            color: #d4a76a;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            text-shadow: 0 0 10px rgba(212, 167, 106, 0.5);
            border-bottom: 2px solid #d4a76a;
            padding-bottom: 0.5rem;
        }
        
        .category-books {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .book-item-admin {
            display: flex;
            gap: 1.5rem;
            background: rgba(244, 228, 188, 0.95);
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
            border: 2px solid #d4a76a;
            align-items: flex-start;
        }
        
        .book-cover-small {
            width: 80px;
            height: 120px;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 1.5rem;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .book-info-admin {
            flex: 1;
            color: #3a2f1e;
        }
        
        .book-info-admin h4 {
            color: #8b4513;
            font-size: 1.2rem;
            margin: 0 0 0.5rem 0;
        }
        
        .book-author-admin {
            margin: 0 0 0.3rem 0;
            font-weight: bold;
            font-style: italic;
        }
        
        .book-meta-admin, .book-category-admin, .book-added-admin {
            margin: 0.2rem 0;
            font-size: 0.9rem;
            color: #666;
        }
        
        .book-actions-admin {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            font-family: 'Georgia', serif;
        }
        
        .action-btn span {
            font-size: 1.1rem;
        }
        
        .action-btn.edit-btn {
            background: linear-gradient(135deg, #d4a76a 0%, #8b4513 100%);
            color: #3a2f1e;
        }
        
        .action-btn.edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 167, 106, 0.6);
        }
        
        .action-btn.delete-btn {
            background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
            color: #fff;
        }
        
        .action-btn.delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 20, 60, 0.6);
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .book-item-admin {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .book-cover-small {
                width: 100px;
                height: 150px;
            }
            
            .book-actions-admin {
                flex-direction: row;
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="logo">ä¸ªäººé­”æ³•ä¹¦æˆ¿</a>
            <div class="menu-toggle" onclick="toggleMenu()">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
            <ul class="nav-links">
                <li><a href="index.html">æˆ‘çš„è—ä¹¦</a></li>
                <li><a href="atlas.html">ä¹¦ç±åœ°å›¾</a></li>
                <li><a href="notes.html">ä¸»é¢˜æœ­è®°</a></li>
                <li><a href="reading_challenge.html">é˜…è¯»æŒ‘æˆ˜</a></li>
                <li><a href="moments.html">ç¬é—´è®°å½•</a></li>
            </ul>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="container">
        <h1>ä¹¦ç±ç®¡ç†</h1>
        <p>ç®¡ç†ä½ çš„æ‰€æœ‰ä¹¦ç±ï¼ŒæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼Œè¿›è¡Œç¼–è¾‘æˆ–åˆ é™¤æ“ä½œã€‚</p>

        <!-- è¿”å›é¦–é¡µæŒ‰é’® -->
        <div style="margin-bottom: 2rem;">
            <a href="index.html" class="btn">
                <span>ğŸ </span> è¿”å›é¦–é¡µ
            </a>
        </div>

        <!-- ä¹¦ç±åˆ—è¡¨ -->
        <section class="books-management">
            <h2>æˆ‘çš„ä¹¦ç±</h2>
            <div id="bookList" class="book-list-admin">
                <!-- ä¹¦ç±å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
            </div>
        </section>
    </div>

    <!-- é¡µè„š -->
    <footer>
        <p>&copy; 2025 The Arcane Study. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
    </footer>

    <!-- æ»šåŠ¨åˆ°é¡¶éƒ¨æŒ‰é’® -->
    <button class="scroll-top-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">&uarr;</button>
</body>
</html>